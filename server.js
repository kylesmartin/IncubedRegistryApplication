"use strict";
exports.__esModule = true;

// incubed and Web3 initializations
var in3_wasm_1 = require('in3-wasm');
var Web3 = require('web3');
var in3 = new in3_wasm_1.IN3({
    proof: 'standard',
    signatureCount: 1,
    requestCount: 1,
    chainId: 'mainnet',
    replaceLatestBlock: 10
});
var web3 = new Web3(in3.createWeb3Provider());

// w3 contract initialization for node data address
var dataAddress = '0xaC1b824795E1EB1F6e609FE0dA9b9af8bEaAb60F';
var dataAbi = [{"constant":true,"inputs":[],"name":"registryId","outputs":[{"name":"","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_index","type":"uint256"}],"name":"getIn3NodeInformation","outputs":[{"components":[{"name":"url","type":"string"},{"name":"deposit","type":"uint256"},{"name":"registerTime","type":"uint64"},{"name":"props","type":"uint192"},{"name":"weight","type":"uint64"},{"name":"signer","type":"address"},{"name":"proofHash","type":"bytes32"}],"name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"_signer","type":"address"}],"name":"getNodeInfromationBySigner","outputs":[{"components":[{"name":"url","type":"string"},{"name":"deposit","type":"uint256"},{"name":"registerTime","type":"uint64"},{"name":"props","type":"uint192"},{"name":"weight","type":"uint64"},{"name":"signer","type":"address"},{"name":"proofHash","type":"bytes32"}],"name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"supportedToken","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_url","type":"string"},{"name":"_props","type":"uint192"},{"name":"_signer","type":"address"},{"name":"_weight","type":"uint64"},{"name":"_owner","type":"address"},{"name":"_deposit","type":"uint256"},{"name":"_stage","type":"uint256"}],"name":"registerNodeFor","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"}],"name":"signerIndex","outputs":[{"name":"lockedTime","type":"uint64"},{"name":"owner","type":"address"},{"name":"stage","type":"uint256"},{"name":"depositAmount","type":"uint256"},{"name":"index","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"unregisteringNode","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"uint256"}],"name":"nodes","outputs":[{"name":"url","type":"string"},{"name":"deposit","type":"uint256"},{"name":"registerTime","type":"uint64"},{"name":"props","type":"uint192"},{"name":"weight","type":"uint64"},{"name":"signer","type":"address"},{"name":"proofHash","type":"bytes32"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_hash","type":"bytes32"},{"name":"_caller","type":"address"}],"name":"setConvict","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"components":[{"name":"lockedTime","type":"uint64"},{"name":"owner","type":"address"},{"name":"stage","type":"uint256"},{"name":"depositAmount","type":"uint256"},{"name":"index","type":"uint256"}],"name":"_si","type":"tuple"}],"name":"adminSetSignerInfo","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_to","type":"address"},{"name":"_amount","type":"uint256"}],"name":"adminTransferDeposit","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"_signer","type":"address"}],"name":"getSignerInformation","outputs":[{"components":[{"name":"lockedTime","type":"uint64"},{"name":"owner","type":"address"},{"name":"stage","type":"uint256"},{"name":"depositAmount","type":"uint256"},{"name":"index","type":"uint256"}],"name":"","type":"tuple"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_url","type":"string"},{"name":"_props","type":"uint192"},{"name":"_weight","type":"uint64"},{"name":"_deposit","type":"uint256"}],"name":"updateNode","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_stage","type":"uint256"}],"name":"adminSetStage","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"timeout","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_newDeposit","type":"uint256"}],"name":"adminSetNodeDeposit","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"ownerContract","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newLogic","type":"address"}],"name":"adminSetLogic","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"totalNodes","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[{"name":"","type":"address"},{"name":"","type":"bytes32"}],"name":"convictMapping","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newTimeout","type":"uint256"}],"name":"adminSetTimeout","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"adminRemoveNodeFromRegistry","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[{"name":"","type":"bytes32"}],"name":"urlIndex","outputs":[{"name":"used","type":"bool"},{"name":"signer","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newToken","type":"address"}],"name":"adminSetSupportedToken","outputs":[{"name":"","type":"bool"}],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"VERSION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"props","type":"uint256"},{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"deposit","type":"uint256"}],"name":"LogNodeRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"signer","type":"address"}],"name":"LogNodeRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"props","type":"uint256"},{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"deposit","type":"uint256"}],"name":"LogNodeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"oldOwner","type":"address"},{"indexed":false,"name":"newOwner","type":"address"}],"name":"LogOwnershipChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"nodeOwner","type":"address"},{"indexed":false,"name":"amount","type":"uint256"}],"name":"LogDepositReturned","type":"event"}];
var dataContract = new web3.eth.Contract(dataAbi, dataAddress);

// w3 contract initialization for registry contract address
var registryAbi = [{"constant":true,"inputs":[],"name":"supportedToken","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"unregisteringNode","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"adminKey","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"minDeposit","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_url","type":"string"},{"name":"_props","type":"uint192"},{"name":"_weight","type":"uint64"},{"name":"_additionalDeposit","type":"uint256"}],"name":"updateNode","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"timestampAdminKeyActive","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_url","type":"string"},{"name":"_props","type":"uint192"},{"name":"_signer","type":"address"},{"name":"_weight","type":"uint64"},{"name":"_depositAmount","type":"uint256"},{"name":"_v","type":"uint8"},{"name":"_r","type":"bytes32"},{"name":"_s","type":"bytes32"}],"name":"registerNodeFor","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"maxDepositFirstYear","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"nodeRegistryData","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"totalNodes","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[],"name":"activateNewLogic","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_url","type":"string"},{"name":"_props","type":"uint192"},{"name":"_weight","type":"uint64"},{"name":"_deposit","type":"uint256"}],"name":"registerNode","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"updateTimeout","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"pendingNewLogic","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":false,"inputs":[{"name":"_newLogic","type":"address"}],"name":"adminUpdateLogic","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"returnDeposit","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"}],"name":"adminRemoveNodeFromRegistry","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_hash","type":"bytes32"}],"name":"convict","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":false,"inputs":[{"name":"_signer","type":"address"},{"name":"_blockhash","type":"bytes32"},{"name":"_blockNumber","type":"uint256"},{"name":"_v","type":"uint8"},{"name":"_r","type":"bytes32"},{"name":"_s","type":"bytes32"}],"name":"revealConvict","outputs":[],"payable":false,"stateMutability":"nonpayable","type":"function"},{"constant":true,"inputs":[],"name":"blockRegistry","outputs":[{"name":"","type":"address"}],"payable":false,"stateMutability":"view","type":"function"},{"constant":true,"inputs":[],"name":"VERSION","outputs":[{"name":"","type":"uint256"}],"payable":false,"stateMutability":"view","type":"function"},{"inputs":[{"name":"_blockRegistry","type":"address"},{"name":"_nodeRegistryData","type":"address"},{"name":"_minDeposit","type":"uint256"}],"payable":false,"stateMutability":"nonpayable","type":"constructor"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"props","type":"uint192"},{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"deposit","type":"uint256"}],"name":"LogNodeRegistered","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"}],"name":"LogNodeConvicted","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"signer","type":"address"}],"name":"LogNodeRemoved","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"url","type":"string"},{"indexed":false,"name":"props","type":"uint192"},{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"deposit","type":"uint256"}],"name":"LogNodeUpdated","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"oldOwner","type":"address"},{"indexed":false,"name":"newOwner","type":"address"}],"name":"LogOwnershipChanged","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"newPendingContract","type":"address"}],"name":"LogNewPendingContract","type":"event"},{"anonymous":false,"inputs":[{"indexed":false,"name":"signer","type":"address"},{"indexed":false,"name":"owner","type":"address"},{"indexed":false,"name":"deposit","type":"uint256"},{"indexed":false,"name":"erc20Token","type":"address"}],"name":"LogDepositReturned","type":"event"}];
var registryAddress = '0x6C095A05764A23156eFD9D603eaDa144a9B1AF33';
var registryContract = new web3.eth.Contract(registryAbi, registryAddress);

// express initializations
var express = require('express');
var app = express();
const port = 3000;

// body parser initializations
var bodyParser = require('body-parser');
app.use( bodyParser.urlencoded({ extended: true }) );
app.use( bodyParser.json() );

// load web page
app.get('/', (req, res) => {
    res.sendFile('index.html', {root: '.'});
});

// get node count
app.get('/nodecount', function (req, res) {
    registryContract.methods.totalNodes().call().then((nodeCount) => {
        res.send(nodeCount.toString());
    }).catch((err) => console.log(err));
});

// get node
app.post('/node', function (req, res) {
    dataContract.methods.nodes(req.body.index).call().then((node) => {
        res.send(node);
    }).catch((err) => console.log(err));
});

// get signer
app.post('/signer', function (req, res) {
    dataContract.methods.getSignerInformation(req.body.signer).call().then((signer) => {
        res.send(signer);
    }).catch((err) => console.log(err));
});

// bind app to port
app.listen(port, () => {
    console.log('listening at http://localhost:'+port.toString());
});
